# 泉策通智能体 v2.0 - 架构说明

## 核心变更

### 1. **统一入口服务**
- 单一服务，单一端口（8000）
- 暴露统一接口：`POST /query`
- 内部完成所有工作流调用

### 2. **意图识别升级**
- **之前**：简单关键词匹配
- **现在**：大模型驱动，严格JSON输出
- 支持4种意图：
  - `policy_parse`（政策解析）
  - `personal_welfare`（福利计算）
  - `regional_compare`（区域对比）
  - `investment_signal`（企业信号灯）

### 3. **数据整理**
所有数据统一放入 `data/` 目录：

data/
├── policies/
│   ├── policies.jsonl           # 主政策库
│   ├── policy_descriptions.md    # 政策描述
│   ├── 家电补贴政策/             # 家电补充政策（MD文件）
│   ├── 数码补贴政策/             # 数码补充政策
│   ├── 汽车补贴政策/             # 汽车补充政策
│   └── 零售餐饮补贴政策/         # 零售餐饮补充政策
└── companies/
    ├── companies_appliance.jsonl # 家电企业库
    ├── companies_digital.jsonl   # 数码企业库
    ├── companies_auto.jsonl      # 汽车企业库
    ├── companies_retail.jsonl    # 零售餐饮企业库
    ├── 企查查家电.xlsx            # 原始数据
    ├── 企查查数码.xlsx
    ├── 企查查汽车.xlsx
    └── 企查查零售餐饮.xlsx


### 4. **工作流模块化**
所有工作流改为函数调用（`workflows/`目录）：

workflows/
├── __init__.py
├── intent_parser.py        # 意图解析（LLM）
├── rag_retriever.py        # RAG检索（统一）
├── policy_parser.py        # 政策解析
├── welfare_calculator.py   # 福利计算
├── regional_comparator.py  # 区域对比
├── company_signal.py       # 企业信号灯
└── llm_writer.py          # LLM润色


### 5. **扁平化输出**
所有节点返回扁平JSON，方便数据获取。

**示例响应：**
json
{
  "success": true,
  "intent": "personal_welfare",
  "raw_text": "在济南买了3000元的空调能领多少补贴？",
  "entities": {
    "location": "济南",
    "product": "空调",
    "industry": "appliance",
    "price_paid": 3000
  },
  "result": {
    "subsidy_amount": 600,
    "subsidy_breakdown": "基础补贴15%: 450元; 以旧换新5%: 150元",
    "total_benefit": 600,
    "claiming_platform": "爱山东APP"
  },
  "final_answer": "您在济南购买3000元的空调，可以享受600元的补贴...",
  "citations": "政策来源1|政策来源2"
}


## 使用方式

### 启动服务

**Linux/Mac:**
bash
chmod +x start_new.sh
./start_new.sh


**Windows:**
start.bat


### 调用接口

bash
curl -X POST http://127.0.0.1:8000/query \
  -H "Content-Type: application/json" \
  -d '{"query": "在济南买了3000元的空调能领多少补贴？"}'


### 停止服务

**Linux/Mac:**
bash
./stop_new.sh


**Windows:**
按 `Ctrl+C` 或关闭命令窗口


## 配置文件

`.env` 文件（大模型配置）：
DASHSCOPE_API_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
DASHSCOPE_API_KEY=your_api_key_here
DASHSCOPE_CHAT_MODEL=qwen-plus
DASHSCOPE_EMBED_MODEL=text-embedding-v3


## 与旧架构对比

| 对比项 | 旧架构 | 新架构 |
|--------|--------|--------|
| 服务数量 | 7个独立服务（8001-8007） | 1个统一服务（8000） |
| 端口数量 | 7个端口 | 1个端口 |
| 意图识别 | 关键词匹配 | 大模型（严格JSON） |
| 数据管理 | 散落在根目录 | 统一data/目录 |
| 节点调用 | HTTP服务间调用 | 函数内部调用 |
| 输出格式 | 嵌套字典 | 扁平JSON |
| 部署复杂度 | 高（需启动多个服务） | 低（单一服务） |

## 优势

1. **简化部署**：只需启动一个服务
2. **降低延迟**：函数调用替代HTTP请求
3. **易于维护**：统一代码库，模块化设计
4. **提升准确性**：LLM驱动的意图识别
5. **数据规范**：统一数据管理目录

## 技术栈

- **Web框架**：FastAPI
- **大模型**：通义千问（DashScope API）
- **向量检索**：text-embedding-v3
- **数据格式**：JSONL（政策/企业）+ Markdown（补充政策）
