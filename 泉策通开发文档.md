# AI政策动态咨询智能体（多工作流）开发文档

本开发文档用于指导在平台中以“代码插件（FastAPI 微服务）”实现四个功能工作流，并与拆分后的知识库进行RAG检索与引用。所有节点统一遵循扁平参数规范，结构化数据以JSON字符串返回；路由统一为`POST /infer`与`GET /health`。

## 一、服务与端口
- 入口意图解析：`ic_ner.py`（端口8001）
- 工作流：
  - 政策智能解析（端口8002）
  - 个人福利计算（端口8003）
  - 区域政策对比（端口8004）
  - 企业投资信号灯（端口8005）
- 共用节点：
  - RAG检索（端口8006）
  - LLM Writer（端口8007）
  - 可选：图表渲染（端口8008）

所有服务统一路由：
- `GET /health`：健康检查，返回`{"status":"ok"}`。
- `POST /infer`：接收扁平参数，返回扁平参数。

## 二、扁平参数规范（统一result字典封装）
- **所有输入/输出均封装在`result`字典中**，方便平台单字段获取完整数据。
- 结构化数据统一以`*_json`承载JSON字符串。
- 多值字段用`|`分隔（例如`kb_citations`）。
- 上下游字段名严格一致，不做重命名。
- 统一意图枚举：`policy_parse`、`personal_welfare`、`regional_compare`、`investment_signal`。

常用字段（均在result字典内）：
- `intent`、`raw_text`、`entity_location`、`entity_product`、`entity_company`、`entity_time`
- `kb_hits_json`（JSON字符串，数组）
- `kb_citations`（`|`分隔URL）
- `policy_struct_json`、`company_struct_json`（JSON字符串，结构化结果）
- `final_text`、`citations`（LLM输出）

## 三、知识库拆分与存储
- 政策叙述（Markdown）：`policy_descriptions.md`
- 政策结构化（JSONL）：`policies.jsonl`
- 企业知识库（按行业拆分，遵循项目记忆规范）：
  - `companies_appliance.jsonl`
  - `companies_auto.jsonl`
  - `companies_retail.jsonl`
  - `companies_digital.jsonl`

说明：本次已将原`总知识库.md`中的JSONL块抽出到`policies.jsonl`，描述与汇总保留在`policy_descriptions.md`。企业知识库文件建议后续由你补充数据并入库。

## 四、RAG检索策略
- 双索引：
  1) 叙述索引（`policy_descriptions.md`）：章节感知分块（H2/H3），chunk 800–1200 tokens，overlap 100–200；Embedding + BM25混合，Cross-Encoder重排。
  2) 政策索引（`policies.jsonl`）：逐记录索引，优先结构化过滤（region、时间、类型）后做Embedding召回并重排。
- 企业索引（按行业文件）：逐记录索引，先结构化过滤（省市、行业），再Embedding + BM25 + 重排。
- 统一输出字段：
  - `kb_hits_json`：命中记录序列化为JSON字符串（数组），含`doc_id/title/summary/region_province/region_city/effective_start/effective_end/applicant_type/industry_tags/benefit_type/benefit_amount/conditions/procedures/source_url/score`。
  - `kb_citations`：`|`分隔的`source_url`列表。

## 五、工作流与节点映射
1) 政策智能解析（8002）
- 入参：`intent`=`policy_parse`、`raw_text`、实体（location/product/company/time）
- 步骤：调用RAG（8006）→生成`kb_hits_json|kb_citations`→结构化解析生成`policy_struct_json`
- 出参：`policy_struct_json`、`kb_hits_json`、`kb_citations`

2) 个人福利计算（8003）
- 入参：`intent`=`personal_welfare`、`raw_text`、`entity_location|entity_time|entity_product`
- 步骤：基于RAG命中政策与个人条件做规则计算（如家电15%+5%、价税合计与上限2000）
- 出参：`calc_result_json`（包含可享额度、约束、所需材料等）

3) 区域政策对比（8004）
- 入参：`intent`=`regional_compare`、`entity_location`（支持多地`|`分隔）、`entity_product`
- 步骤：各地命中政策的关键指标对比（补贴率、上限、申请窗口、申领平台）
- 出参：`compare_result_json`（数组-JSON字符串）、`kb_citations`

4) 企业投资信号灯（8005）
- 入参：`intent`=`investment_signal`、`entity_industry`、`entity_location`（默认山东/济南）
- 步骤：企业库检索与结构化评分（创新、扩张意愿、渠道）；结合政策导向生成信号灯
- 出参：`company_struct_json`（含评分与推荐）、`kb_citations`

5) RAG检索（8006）
- 入参：`raw_text`、`entity_*`过滤字段
- 出参：`kb_hits_json`、`kb_citations`

6) LLM Writer（8007）
- 入参：上游`*_json`与`kb_citations`
- 步骤：基于`.env`的DashScope兼容模式，封装统一的`POST /infer`调用，生成用户呈现文本
- 出参：`final_text`、`citations`

## 六、ic_ner入口节点改造建议（8001）
- 将`POST /parse`改为`POST /infer`。
- 返回结构统一封装在`result`字典中。
- 示例响应：
```
{
  "result": {
    "intent": "policy_parse",
    "raw_text": "在济南买空调能享受多少补贴？",
    "entity_location": "济南",
    "entity_product": "空调",
    "entity_company": null,
    "entity_time": "2025年"
  }
}
```

## 七、企业知识库字段建议（JSONL）
- 示例字段：
  - `company_id`、`name`、`province`、`city`、`industry`（家电/汽车/零售餐饮/数码）
  - `main_products`（数组）、`patents_count`、`rd_investment_ratio`、`innovation_score`
  - `recruitment_intent_score`、`news_sentiment_score`、`expansion_willingness`（low/medium/high）
  - `existing_channels`（数组）、`source_urls`（数组）、`last_updated`
- 文件：`companies_appliance.jsonl`、`companies_auto.jsonl`、`companies_retail.jsonl`、`companies_digital.jsonl`

## 八、接口示例
- RAG检索（8006）请求：
```
{
  "result": {
    "raw_text": "2025济南空调补贴",
    "entity_location": "济南",
    "entity_product": "空调"
  }
}
```
- RAG检索响应：
```
{
  "result": {
    "kb_hits_json": "[...]",
    "kb_citations": "url1|url2"
  }
}
```

## 九、启动与停止脚本建议
- `start.sh`：逐服务`uvicorn {module}:app --port {port} --workers 2 > logs/{name}.log 2>&1 &`，并写入独立`{name}.pid`。
- `stop.sh`：逐服务读取并`kill -15`对应PID，找不到则`ps`提示。

## 十、错误码与重试
- 统一错误码：`E_INPUT_EMPTY`、`E_RAG_NO_HIT`、`E_CALC_RULE`、`E_LLM_FAIL`等。
- 重试策略：RAG召回失败退回BM25；LLM调用指数退避。

## 十一、安全与合规
- `.env`中的API KEY仅后端读取，不在日志或响应中输出。
- 所有对外文本输出携带`kb_citations`引用。

## 十二、LLM封装（DashScope兼容）
- 统一`POST /infer`，后端与`.env`对接`chat-completions`语义；仅生成文本，不做业务计算。
