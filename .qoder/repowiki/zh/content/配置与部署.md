# 配置与部署

<cite>
**本文档引用文件**  
- [requirements.txt](file://requirements.txt)
- [mcp_servers.json](file://mcp_servers.json)
- [start_new.sh](file://start_new.sh)
- [start.bat](file://start.bat)
- [stop_new.sh](file://stop_new.sh)
- [.env](file://.env)
- [app.py](file://app.py)
- [app_with_mcp.py](file://app_with_mcp.py)
- [mcp_tools/tool_orchestrator.py](file://mcp_tools/tool_orchestrator.py)
- [workflows/intent_parser.py](file://workflows/intent_parser.py)
- [mcp_tools/context_manager.py](file://mcp_tools/context_manager.py)
- [data/context_history.jsonl](file://data/context_history.jsonl)
- [logs/app.log](file://logs/app.log)
</cite>

## 目录
1. [依赖管理](#依赖管理)
2. [环境配置](#环境配置)
3. [MCP服务配置](#mcp服务配置)
4. [部署流程](#部署流程)
5. [运行模式](#运行模式)
6. [日志与监控](#日志与监控)

## 依赖管理

本系统基于Python开发，依赖通过`requirements.txt`文件管理。部署时需确保Python环境已安装，并通过pip安装所需依赖。

部署脚本已内置依赖检查与安装逻辑，会自动安装以下核心依赖：
- FastAPI：用于构建RESTful API服务
- Uvicorn：ASGI服务器，用于运行FastAPI应用
- python-dotenv：用于加载`.env`环境变量文件
- httpx：用于异步HTTP请求
- pydantic：用于数据验证与模型定义
- requests：用于同步HTTP请求

**Section sources**
- [requirements.txt](file://requirements.txt#L1-L7)
- [start_new.sh](file://start_new.sh#L16)
- [start.bat](file://start.bat#L18)

## 环境配置

系统通过`.env`文件配置关键环境变量，用于连接大模型服务。需在项目根目录创建`.env`文件，并配置以下参数：

- **DASHSCOPE_API_BASE_URL**：大模型API基础URL，用于调用通义千问等模型服务
- **DASHSCOPE_API_KEY**：大模型API密钥，用于身份认证
- **DASHSCOPE_CHAT_MODEL**：指定使用的聊天模型名称，默认为`qwen-plus`

这些环境变量在多个模块中被引用，包括意图解析、工具决策等核心流程。`.env`文件中的密钥信息不会在日志或响应中输出，确保安全性。

**Section sources**
- [mcp_tools/tool_orchestrator.py](file://mcp_tools/tool_orchestrator.py#L18-L20)
- [workflows/intent_parser.py](file://workflows/intent_parser.py#L11-L13)
- [mcp_tools/tool_orchestrator.py](file://mcp_tools/tool_orchestrator.py#L6-L16)

## MCP服务配置

MCP（Multi-agent Collaboration Platform）服务通过`mcp_servers.json`文件进行配置，定义了多个可调用的智能工具服务端点。该文件采用JSON格式，结构清晰，便于扩展。

配置文件包含以下MCP服务：
- **quickchart**：图表生成服务，用于生成对比图、柱状图、流程图等可视化图表
- **amap-maps**：高德地图服务，用于生成产业分布地图
- **fetch**：实时政策抓取服务，用于获取最新政策信息
- **context7-mcp**：上下文对话管理服务，用于维护对话历史与上下文关联

每个服务配置包含`type`（服务类型）和`url`（服务地址）两个字段，当前均使用`streamable_http`类型，通过HTTP流式调用。

**Section sources**
- [mcp_servers.json](file://mcp_servers.json#L1-L21)
- [mcp_tools/tool_orchestrator.py](file://mcp_tools/tool_orchestrator.py#L7-L14)
- [app_with_mcp.py](file://app_with_mcp.py#L21)

## 部署流程

系统提供跨平台部署脚本，支持Linux/Mac和Windows系统。

### Linux/Mac系统
1. 赋予启动脚本执行权限：`chmod +x start_new.sh`
2. 启动服务：`./start_new.sh`
3. 停止服务：`./stop_new.sh`

### Windows系统
1. 双击运行`start.bat`启动服务
2. 服务启动后会保持窗口打开，按`Ctrl+C`或关闭窗口停止服务

启动脚本会自动检查Python环境、安装依赖、创建日志目录，并以后台进程方式启动服务。服务默认运行在`0.0.0.0:8000`地址。

**Section sources**
- [start_new.sh](file://start_new.sh#L1-L35)
- [start.bat](file://start.bat#L1-L39)
- [stop_new.sh](file://stop_new.sh#L1-L36)

## 运行模式

系统支持两种运行模式，通过不同的入口文件启动：

### 基础模式
- 启动文件：`app.py`
- 服务端口：8000
- 功能特点：提供核心政策解析、福利计算、区域对比、企业信号灯等四大功能
- 适用场景：开发调试、基础功能验证

### MCP增强模式
- 启动文件：`app_with_mcp.py`
- 服务端口：8001
- 功能特点：在基础功能上集成MCP工具增强，支持图表生成、地图可视化、实时政策更新和上下文对话管理
- 适用场景：生产环境、完整功能体验

生产部署推荐使用MCP增强模式，以获得更丰富的交互体验和更强的分析能力。

**Section sources**
- [app.py](file://app.py#L153-L155)
- [app_with_mcp.py](file://app_with_mcp.py#L220-L222)
- [app_with_mcp.py](file://app_with_mcp.py#L47-L170)

## 日志与监控

系统提供完善的日志记录与健康检查机制，便于运维监控。

### 日志管理
- 日志目录：`logs/`
- 日志文件：`app.log`
- 日志内容：包含服务启动、请求处理、错误信息等
- 查看方式：
  - Linux/Mac：`tail -f logs/app.log`
  - Windows：`type logs\app.log`

### 健康检查
- 健康检查端点：`GET /health`
- 返回示例：
```json
{
  "status": "ok",
  "service": "泉策通智能体",
  "version": "2.0"
}
```
- MCP增强版额外返回工具列表信息

### 对话历史存储
- 存储路径：`data/context_history.jsonl`
- 存储格式：每行一个JSON对象，记录对话ID、时间戳、查询内容、意图和结果
- 用途：支持上下文关联查询，实现多轮对话能力

**Section sources**
- [start_new.sh](file://start_new.sh#L19)
- [start.bat](file://start.bat#L21)
- [app.py](file://app.py#L130-L137)
- [mcp_tools/context_manager.py](file://mcp_tools/context_manager.py#L8)
- [mcp_tools/context_manager.py](file://mcp_tools/context_manager.py#L24-L51)