# 企业投资信号灯工作流

<cite>
**本文档引用的文件**   
- [company_signal.py](file://workflows/company_signal.py)
- [companies_appliance.jsonl](file://data/companies/companies_appliance.jsonl)
- [companies_digital.jsonl](file://data/companies/companies_digital.jsonl)
- [companies_auto.jsonl](file://data/companies/companies_auto.jsonl)
- [companies_retail.jsonl](file://data/companies/companies_retail.jsonl)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [架构概述](#架构概述)
4. [详细组件分析](#详细组件分析)
5. [可扩展性讨论](#可扩展性讨论)

## 项目结构
该模块位于`workflows`目录下，是企业投资决策支持系统的核心分析组件。它通过读取`data/companies/`目录下的JSONL格式企业数据文件，对特定行业的企业进行评分和推荐。系统支持家电、数码、汽车和零售餐饮四个行业，每个行业有独立的数据文件。模块通过`analyze_company_signal`主函数处理`investment_signal`意图，输出投资建议。

```mermaid
graph TD
subgraph "输入"
A[用户查询] --> B[意图解析]
C[企业数据] --> D[数据加载]
end
subgraph "处理"
B --> E[行业识别]
D --> F[企业评分]
E --> G[信号灯分析]
F --> G
end
subgraph "输出"
G --> H[推荐企业]
G --> I[行业概况]
G --> J[投资信号]
end
```

**图表来源**
- [company_signal.py](file://workflows/company_signal.py#L62-L149)
- [companies_appliance.jsonl](file://data/companies/companies_appliance.jsonl)

**章节来源**
- [company_signal.py](file://workflows/company_signal.py#L1-L150)

## 核心组件
`company_signal.py`模块实现了企业投资信号灯工作流，主要包含三个核心函数：`_load_companies`用于加载企业数据，`_score_company`用于计算企业评分，`analyze_company_signal`作为主函数协调整个分析流程。这些函数共同构成了一个完整的投资决策支持系统，能够根据企业数据生成推荐列表和投资建议。

**章节来源**
- [company_signal.py](file://workflows/company_signal.py#L15-L149)

## 架构概述
该模块采用分层架构设计，从数据加载到评分计算再到结果生成，形成了清晰的处理流水线。首先通过`_load_companies`函数从JSONL文件中加载企业数据，然后使用`_score_company`函数对每家企业进行多维度评分，最后在`analyze_company_signal`函数中完成数据过滤、排序和结果格式化。这种设计使得系统具有良好的可维护性和可扩展性。

```mermaid
graph TD
A[输入: raw_text, entities] --> B{行业存在?}
B --> |否| C[返回错误]
B --> |是| D[加载企业库]
D --> E{企业数据存在?}
E --> |否| F[返回无数据]
E --> |是| G[地域过滤]
G --> H[计算评分]
H --> I[排序Top 10]
I --> J[生成推荐列表]
J --> K[计算平均分]
K --> L{平均分 >= 70?}
L --> |是| M[绿灯]
L --> |>=40| N[黄灯]
L --> |<40| O[红灯]
M --> P[返回结果]
N --> P
O --> P
```

**图表来源**
- [company_signal.py](file://workflows/company_signal.py#L62-L149)

**章节来源**
- [company_signal.py](file://workflows/company_signal.py#L62-L149)

## 详细组件分析
### 数据源配置与加载
模块通过`COMPANY_FILES`字典配置了四个行业的数据源路径，分别对应家电、数码、汽车和零售餐饮行业。`_load_companies`函数根据指定的行业名称加载相应的JSONL文件，支持地域过滤功能。该函数实现了健壮的错误处理机制，在文件不存在或解析失败时能够优雅地处理异常情况。

```mermaid
classDiagram
class COMPANY_FILES {
+appliance : str
+digital : str
+car : str
+retail_catering : str
}
class _load_companies {
+industry : str
+return : List[Dict]
}
class analyze_company_signal {
+raw_text : str
+entities : Dict
+return : Dict
}
COMPANY_FILES --> _load_companies : "使用"
_load_companies --> analyze_company_signal : "提供数据"
```

**图表来源**
- [company_signal.py](file://workflows/company_signal.py#L7-L37)

**章节来源**
- [company_signal.py](file://workflows/company_signal.py#L7-L37)
- [companies_appliance.jsonl](file://data/companies/companies_appliance.jsonl)

### 评分函数算法解析
`_score_company`函数实现了多维度的企业评分算法，主要包含三个评分维度：创新分、扩展意愿和渠道数量。创新分直接从企业数据中的`innovation_score`字段获取，并乘以0.3的权重；扩展意愿根据"high"、"medium"、"low"三个等级分别加30、15分；渠道数量按每个渠道5分计算，上限20分。最终得分为各维度得分的总和，保留两位小数。

```mermaid
flowchart TD
Start([开始]) --> A[获取创新分]
A --> B[创新分 * 0.3]
B --> C[获取扩展意愿]
C --> D{扩展意愿?}
D --> |high| E[加30分]
D --> |medium| F[加15分]
D --> |low| G[加0分]
E --> H[计算渠道数量]
F --> H
G --> H
H --> I[渠道数 * 5, 上限20]
I --> J[总分 = 创新分 + 扩展分 + 渠道分]
J --> K[四舍五入保留2位小数]
K --> End([结束])
```

**图表来源**
- [company_signal.py](file://workflows/company_signal.py#L40-L59)

**章节来源**
- [company_signal.py](file://workflows/company_signal.py#L40-L59)

### 主函数执行流程
`analyze_company_signal`函数是整个模块的入口点，负责协调各个组件完成投资信号分析。执行流程包括：首先从实体中提取行业和地域信息，然后加载相应行业的企业数据，接着根据地域进行过滤（若无匹配则使用全部数据），计算每家企业的得分并按得分降序排序，选取Top 10企业生成推荐列表，最后根据平均分输出绿/黄/红灯投资建议。

```mermaid
sequenceDiagram
participant 用户
participant 主函数 as analyze_company_signal
participant 加载 as _load_companies
participant 评分 as _score_company
用户->>主函数 : 发起投资信号分析请求
主函数->>主函数 : 提取行业和地域信息
主函数->>加载 : 调用_load_companies(行业)
加载-->>主函数 : 返回企业列表
主函数->>主函数 : 按地域过滤企业
loop 对每家企业
主函数->>评分 : 调用_score_company(企业)
评分-->>主函数 : 返回评分
主函数->>主函数 : 存储企业评分
end
主函数->>主函数 : 按评分排序，取Top 10
主函数->>主函数 : 生成推荐列表和行业概况
主函数->>主函数 : 根据平均分确定投资信号
主函数-->>用户 : 返回推荐企业、行业概况和投资信号
```

**图表来源**
- [company_signal.py](file://workflows/company_signal.py#L62-L149)

**章节来源**
- [company_signal.py](file://workflows/company_signal.py#L62-L149)

## 可扩展性讨论
该模块设计具有良好的可扩展性，未来可以接入更复杂的评估模型。当前的评分算法相对简单，主要基于三个维度的加权计算。通过修改`_score_company`函数，可以引入更多评估维度，如财务状况、市场占有率、技术专利数量等。此外，可以将评分算法抽象为独立的评估引擎，支持配置不同的评估模型，甚至集成机器学习模型进行智能评分。地域过滤逻辑也可以进一步优化，支持更复杂的地理空间查询。

**章节来源**
- [company_signal.py](file://workflows/company_signal.py#L40-L59)